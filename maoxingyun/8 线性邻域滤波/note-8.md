# 线性邻域滤波专场：方框滤波、均值滤波与高斯滤波

## 理论概念

### 关于平滑处理

“平滑处理“（smoothing）也称“模糊处理”（bluring），是一项简单且使用频率很高的图像处理方法。

平滑处理的用途有很多，最常见的是用来减少图像上的噪点或者失真。  
在涉及到降低图像分辨率时，平滑处理是非常好用的方法。

<br>

### 关于滤波

图像滤波，即在尽量保留图像细节特征的条件下对目标图像的噪声进行抑制。

消除图像中的噪声成分叫作图像的平滑化或滤波操作。  
信号或图像的能量大部分集中在幅度谱的低频和中频段是很常见的；而在较高频段，感兴趣的信息经常被噪声淹没。  
因此一个能降低高频成分幅度的滤波器就能够减弱噪声的影响。

图像滤波的目的有两个:  
一是抽出对象的特征作为图像识别的特征模式;  
另一个是为适应图像处理的要求，消除图像数字化时所混入的噪声。

而对滤波处理的要求也有两条:  
一是不能损坏图像的轮廓及边缘等重要信息;  
二是使图像清晰视觉效果好。

<br>

### 关于平滑滤波

平滑滤波是低频增强的空间域滤波技术。

它的目的有两类：一类是模糊；另一类是消除噪音。

空间域的平滑滤波一般采用简单平均法进行，就是求邻近像元点的平均亮度值。  
邻域的大小与平滑的效果直接相关，邻域越大平滑的效果越好，但邻域过大，平滑会使边缘信息损失的越大，从而使输出的图像变得模糊，因此需合理选择邻域的大小。

<br>

### OpenCV提供的滤波
关于滤波器，一种形象的比喻法是：我们可以把滤波器想象成一个包含加权系数的窗口，当使用这个滤波器平滑处理图像时，就把这个窗口放到图像之上，透过这个窗口来看我们得到的图像。

滤波器的种类有很多， 在OpenCV2中，提供了如下五种常用的图像平滑处理操作方法，且他们分别被封装在单独的函数中，使用起来非常方便：

- 方框滤波 —— boxFilter函数
  
- 均值滤波（邻域平均滤波）—— blur函数
  
- 高斯滤波 —— GaussianBlur函数
  
- 中值滤波 —— medianBlur函数
  
- 双边滤波 —— bilateralFilter函数


其中，方框滤波，均值滤波和高斯滤波是线性滤波；而中值滤波和双边滤波是非线性滤波。

<br>

### 线性滤波器

线性滤波器经常用于剔除输入信号中不想要的频率或者从许多频率中选择一个想要的频率。

几种常见的线性滤波器：

- 允许低频率通过的低通滤波器。
  
- 允许高频率通过的高通滤波器。
  
- 允许一定范围频率通过的带通滤波器。
  
- 阻止一定范围频率通过并且允许其它频率通过的带阻滤波器。
  
- 允许所有频率通过、仅仅改变相位关系的全通滤波器，使用起来非常方便。
  
- 阻止一个狭窄频率范围通过的特殊带阻滤波器，陷波滤波器（Band-stop filter）。

<br>

### 关于区分滤波和模糊

以高斯滤波为例，高斯滤波是指用高斯函数作为滤波函数的滤波操作，至于是不是模糊，要看是高斯低通还是高斯高通，**低通就是模糊，高通就是锐化**。

所以：

- 高斯滤波是指用高斯函数作为滤波函数的滤波操作。

- 高斯模糊就是高斯低通滤波。

<br>

### 邻域算子与线性邻域滤波

讲得这么高级，其实就是卷积，不写了。

<br>

### 方框滤波（boxFilter）

使用方框滤波器（box filter）来模糊一张图片，从`src`输入，从`dst`输出。

```C++
void boxFilter(InputArray src, OutputArray dst, int ddepth, Size ksize, Point anchor = Point(-1,-1), boolnormalize = true, int borderType = BORDER_DEFAULT )
```

- 第一个参数，`InputArray`类型的`src`，输入图像，即源图像，填`Mat`类的对象即可。  
  该函数对通道是独立处理的，且可以处理任意通道数的图片。  
  但需要注意，待处理的图片深度应该为`CV_8U, CV_16U, CV_16S, CV_32F`以及 `CV_64F`之一。
  
- 第二个参数，`OutputArray`类型的`dst`，即目标图像，需要和源图片有一样的尺寸和类型。  
  比如可以用Mat::Clone，以源图片为模板，来初始化得到如假包换的目标图。

- 第三个参数，`int`类型的`ddepth`，输出图像的深度，-1代表使用原图深度，即`src.depth()`。

- 第四个参数，`Size`类型（对`Size`类型稍后有讲解）的`ksize`，内核的大小。  
  一般这样写`Size(w,h)`来表示内核的大小( 其中，`w`为像素宽度， `h`为像素高度)。  
  `Size(3,3)`就表示3x3的核大小，`Size(5,5)`就表示5x5的核大小

- 第五个参数，`Point`类型的`anchor`，表示锚点（即被平滑的那个点）。  
  注意他有默认值`Point(-1,-1)`。
  如果这个点坐标是负值的话，就表示取核的中心为锚点，所以默认值`Point(-1,-1)`表示这个锚点在核的中心。
  
- 第六个参数，`bool`类型的`normalize`，默认值为`true`，表示内核是否被其区域归一化（normalized）了。

- 第七个参数，`int`类型的`borderType`，用于推断图像外部像素的某种边界模式。  
  有默认值`BORDER_DEFAULT`，我们一般不去管它。

<br>

**卷积核**

`boxFilter()`函数方框滤波所用的核为：

$$
  K = a\begin{bmatrix}
        1 &1 &... &1 &1\\ 
        1 &1 &... &1 &1\\ 
        1 &1 &... &1 &1
       \end{bmatrix}
$$

其中

当`normalize = true`时，  $a = 1/(ksize.width*ksize.height)$

当`normalize = false`时， $a = 1$

- 可以发现，当`normalize = true`的时候，方框滤波就变成了均值滤波。  
  也就是说，均值滤波是方框滤波归一化后的特殊情况。

- 而非归一化的方框滤波用于计算每个像素邻域内的积分特性，比如密集光流算法（dense optical flow algorithms）中用到的图像倒数的协方差矩阵（covariance matrices of image derivatives）。

- 如果我们要在可变的窗口中计算像素总和，可以使用`integral( )`函数。

<br>

### 均值滤波（blur)

均值滤波，是最简单的一种滤波操作，是典型的线性滤波算法。

主要方法为邻域平均法，即用一片图像区域的各个像素的均值来代替原图像中的各个像素值。一般需要在图像上对目标像素给出一个模板（内核），该模板包括了其周围的临近像素（比如以目标像素为中心的周围8（3x3-1）个像素，构成一个滤波模板，即去掉目标像素本身）。再用模板中的全体像素的平均值来代替原来像素值。

其实均值滤波就是归一化后的方框滤波，`blur`函数内部中就是调用了一下`boxFilter`。

**缺陷**

均值滤波本身存在着固有的缺陷，即它不能很好地保护图像细节，在图像去噪的同时也破坏了图像的细节部分，从而使图像变得模糊，不能很好地去除噪声点。

**OpenCV中的blur函数**

`blur`函数的作用是，对输入的图像 src 进行均值滤波后用 dst 输出。

`blur`函数文档中，给出的其核是这样的：
$$
  K = \frac{1}{ksize.width*ksize.height}
     \begin{bmatrix}
        1 &1 &... &1 &1\\ 
        1 &1 &... &1 &1\\ 
        1 &1 &... &1 &1
       \end{bmatrix}
$$
这个内核一看就明了，就是在求均值，即`blur`函数封装的就是均值滤波。

```C++
void blur(InputArray src, OutputArraydst, Size ksize, Point anchor = Point(-1,-1), int borderType = BORDER_DEFAULT )
```
